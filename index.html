<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>JUIMOR - Estimateur d'Alcool√©mie</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- AM√âLIORATION PERFORMANCE : L'attribut &display=swap rend le texte visible imm√©diatement -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --app-height: 100vh; }
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .app-screen { height: var(--app-height); }
        .juimor-gauge-bg { stroke: #4b5563; }
        .juimor-gauge-fg {
            transition: stroke 0.5s ease-in-out, stroke-dashoffset 0.5s ease-in-out;
            transform: rotate(-90deg); transform-origin: center;
        }
        .glass-card {
            background-color: rgba(31, 41, 55, 0.6);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .modal-backdrop { 
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
        }
        .preset-btn, .stepper-btn, .action-btn { 
            transition: transform 0.1s ease-in-out, background-color 0.2s; 
        }
        .preset-btn:active, .stepper-btn:active, .action-btn:active { transform: scale(0.95); }
        .history-item.selected { border-color: #f59e0b; background-color: #374151; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 to-gray-900 text-white antialiased">

    <!-- ==== SETUP SCREEN ==== -->
    <div id="setup-screen" class="app-screen flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-md mx-auto glass-card rounded-2xl p-6 md:p-8 shadow-2xl">
            <h1 class="text-4xl font-black text-center text-amber-400 mb-2">JUIMOR</h1>
            <p class="text-center text-gray-400 mb-8">Configure ton profil</p>

            <form id="setup-form" class="space-y-4">
                <input type="text" id="user-name" placeholder="Ton nom" class="w-full bg-gray-700/50 border-2 border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-amber-500" required 
                       maxlength="15" pattern="^[\p{L} ]+$" title="15 caract√®res max. Lettres et accents uniquement.">
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="flex items-center bg-gray-700/50 border-2 border-gray-600 rounded-lg focus-within:border-amber-500">
                        <input type="number" min="30" max="500" id="user-weight" placeholder="Poids" class="w-full bg-transparent px-4 py-3 text-white focus:outline-none" required>
                        <span class="text-gray-400 pr-4">kg</span>
                    </div>
                    <select id="user-gender" class="w-full bg-gray-700/50 border-2 border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-amber-500" required>
                        <option value="" disabled selected>Sexe</option>
                        <option value="male">Homme</option>
                        <option value="female">Femme</option>
                    </select>
                </div>

                <div>
                    <label class="text-sm font-medium text-gray-400">Ta boisson pr√©f√©r√©e</label>
                    <select id="fav-drink-type" class="w-full mt-1 bg-gray-700/50 border-2 border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-amber-500 mb-2">
                        <option value="Bi√®re">Bi√®re</option><option value="Vin">Vin</option><option value="Spiritueux">Spiritueux</option><option value="Shot">Shot</option><option value="Cocktail">Cocktail</option>
                    </select>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="number-stepper" data-value="7" data-step="0.5" data-min="0" data-unit="¬∞"></div>
                        <div class="number-stepper" data-value="50" data-unit="cl"></div>
                    </div>
                </div>

                <div>
                    <label for="target-level" class="text-sm font-medium text-gray-400">Ton taux JUIMOR pr√©f√©r√© (sur 10)</label>
                    <input type="range" id="target-level" min="1" max="10" value="5" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer mt-2 accent-amber-500">
                    <div class="text-center font-bold text-lg" id="target-level-display">5</div>
                </div>

                <button type="submit" class="w-full bg-amber-500 hover:bg-amber-600 text-gray-900 font-bold py-3 px-4 rounded-lg transition duration-300 shadow-lg">Commencer</button>
            </form>
            <div class="mt-6 p-3 bg-amber-500/10 border border-amber-500/30 rounded-lg text-center">
                <p class="text-xs text-amber-300">
                    <strong>Attention :</strong> Cette application fournit une <strong>estimation</strong> √† but informatif. Elle ne remplace pas un √©thylotest homologu√©. Le seul taux s√ªr pour conduire est 0.
                </p>
            </div>
        </div>
    </div>

    <!-- ==== MAIN SCREEN (NO-SCROLL LAYOUT) ==== -->
    <div id="main-screen" class="hidden app-screen flex flex-col p-4 md:p-6 relative overflow-hidden">
        <header class="flex-shrink-0 flex justify-between items-start">
            <div>
                <div class="flex items-baseline space-x-2">
                    <h1 class="text-2xl font-black text-amber-400">JUIMOR</h1>
                    <span id="version" class="text-xs text-gray-600">v2.5</span>
                </div>
                <button id="reset-btn" class="text-xs text-gray-500 hover:text-amber-400 transition mt-1">R√©initialiser</button>
            </div>
            <div class="text-right">
                <p id="display-name" class="font-bold text-lg"></p>
                <p id="session-time" class="text-sm text-gray-400">Session: 00:00:00</p>
            </div>
        </header>

        <main class="flex-grow flex flex-col items-center justify-center">
             <div class="relative w-64 h-64 md:w-80 md:h-80 my-4">
                <svg class="w-full h-full" viewBox="0 0 100 100">
                    <circle class="juimor-gauge-bg" cx="50" cy="50" r="45" stroke-width="10" fill="transparent" />
                    <circle id="juimor-gauge" class="juimor-gauge-fg" cx="50" cy="50" r="45" stroke-width="10" fill="transparent" stroke-dasharray="282.7" stroke-dashoffset="282.7" />
                </svg>
                <div class="absolute inset-0 flex flex-col items-center justify-center">
                    <p class="text-gray-400 text-lg">Taux Actuel</p>
                    <div class="flex items-baseline justify-center space-x-2">
                        <p id="current-level" class="text-7xl md:text-8xl font-black transition-colors duration-500">0.0</p>
                        <span class="text-4xl md:text-5xl font-bold text-gray-500">/10</span>
                    </div>
                    <p class="text-gray-400 text-lg">Objectif: <span id="display-target" class="font-bold text-amber-400"></span></p>
                </div>
            </div>
            <p id="bac-legal-info" class="text-center text-gray-400 mb-2 h-5"></p>
            <p id="time-to-zero" class="text-center text-amber-400 font-bold h-5"></p>
        </main>

        <div class="flex-shrink-0 w-full max-w-2xl mx-auto flex flex-col" style="height: 45%;">
            <div class="flex-shrink-0 glass-card rounded-lg p-2 mb-2" style="height: calc(40% - 0.5rem);">
                <canvas id="bac-chart"></canvas>
            </div>
            <div id="drinks-history-container" class="flex-grow flex flex-col min-h-0 mb-2">
                <h2 class="font-bold text-lg mb-2 flex-shrink-0">Historique</h2>
                <div id="drinks-history" class="flex-grow overflow-y-auto space-y-2 glass-card p-3 rounded-lg"></div>
            </div>
            <div id="action-buttons" class="grid grid-cols-2 gap-3 flex-shrink-0">
                <button id="add-drink-btn" class="action-btn col-span-2 bg-amber-500 hover:bg-amber-600 text-gray-900 font-bold py-3 rounded-lg text-lg shadow-lg">+ Ajouter une conso</button>
                <button id="edit-drink-btn" class="action-btn hidden bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-lg text-lg">Modifier</button>
                <button id="sister-drink-btn" class="action-btn hidden bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 rounded-lg text-lg">La petite soeur</button>
                <button id="add-water-btn" class="action-btn col-span-2 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 rounded-lg text-md mt-1">üíß Ajouter un verre d'eau</button>
            </div>
        </div>
    </div>

    <!-- ==== ADD DRINK MODAL ==== -->
    <div id="add-drink-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="glass-card rounded-2xl shadow-2xl w-full max-w-sm p-6">
            <h2 id="modal-title" class="text-2xl font-bold mb-4 text-center">Nouvelle Conso</h2>
            <div class="grid grid-cols-5 gap-2 mb-4">
                <button class="preset-btn flex flex-col items-center justify-center bg-gray-700/80 p-2 rounded-lg" data-name="Bi√®re" data-type="Bi√®re" data-abv="5" data-vol="33"></button>
                <button class="preset-btn flex flex-col items-center justify-center bg-gray-700/80 p-2 rounded-lg" data-name="Vin" data-type="Vin" data-abv="12" data-vol="12.5"></button>
                <button class="preset-btn flex flex-col items-center justify-center bg-gray-700/80 p-2 rounded-lg" data-name="Spiritueux" data-type="Spiritueux" data-abv="40" data-vol="4"></button>
                <button class="preset-btn flex flex-col items-center justify-center bg-gray-700/80 p-2 rounded-lg" data-name="Shot" data-type="Shot" data-abv="40" data-vol="3"></button>
                <button class="preset-btn flex flex-col items-center justify-center bg-gray-700/80 p-2 rounded-lg" data-name="Cocktail" data-type="Cocktail"></button>
                <button class="preset-btn col-span-5 flex items-center justify-center bg-gray-700/80 p-3 rounded-lg mt-2" id="fav-drink-preset-btn"></button>
            </div>
            
            <div id="cocktail-presets-container" class="hidden mb-4">
                <h3 class="text-center text-gray-400 font-bold text-sm mb-2">COCKTAILS CLASSIQUES</h3>
                <div id="cocktail-presets-grid" class="grid grid-cols-4 gap-2"></div>
            </div>

            <form id="add-drink-form" class="space-y-4">
                <input type="hidden" id="editing-drink-id">
                <input type="text" id="drink-name" placeholder="Nom de la boisson" class="w-full bg-gray-700/50 border-2 border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-amber-500" required
                       maxlength="15" pattern="^[\p{L} ]+$" title="15 caract√®res max. Lettres et accents uniquement.">
                
                <div id="simple-drink-fields" class="grid grid-cols-2 gap-4">
                    <div id="drink-abv-stepper" class="number-stepper" data-value="5" data-step="0.5" data-min="0" data-unit="¬∞"></div>
                    <div id="drink-vol-stepper" class="number-stepper" data-value="33" data-unit="cl"></div>
                </div>
                
                <div id="mixed-drink-section" class="hidden space-y-2 pt-2 border-t border-gray-600">
                   <label class="flex items-center justify-center text-sm text-gray-400 cursor-pointer"><input type="checkbox" id="is-mixed-drink" class="accent-amber-500 h-4 w-4 mr-2">C'est un cocktail / m√©lange</label>
                   <div id="mixed-drink-fields" class="hidden space-y-4">
                       <div class="number-stepper" data-value="25" data-unit="cl" title="Volume total"></div>
                       <div class="number-stepper" data-value="40" data-step="1" data-min="0" data-unit="¬∞" title="Degr√© alcool fort"></div>
                       <div class="number-stepper" data-value="20" data-step="5" data-min="0" data-max="100" data-unit="%" title="Pourcentage alcool fort"></div>
                   </div>
                </div>

                <div class="flex space-x-4 pt-4">
                    <button type="button" id="cancel-drink-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg transition">Annuler</button>
                    <button type="submit" id="save-drink-btn" class="w-full bg-amber-500 hover:bg-amber-600 text-gray-900 font-bold py-3 px-4 rounded-lg transition">Ajouter</button>
                </div>
            </form>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- MOBILE VIEWPORT FIX ---
        function setAppHeight() { document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`); }
        window.addEventListener('resize', setAppHeight); window.addEventListener('orientationchange', setAppHeight); setAppHeight();

        // --- SVG ICONS ---
        const ICONS = {
            'Bi√®re': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2v2a5 5 0 0 1 5 5v11a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V9a5 5 0 0 1 5-5V2"/><path d="M18 9h2a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1h-2"/><path d="M15 12H9"/></svg>`,
            'Vin': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 22h8"/><path d="M12 14v8"/><path d="M12 14a5 5 0 0 0 5-5V4H7v5a5 5 0 0 0 5 5Z"/></svg>`,
            'Spiritueux': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 7H3"/><path d="m18 7-1.5-4.5a1 1 0 0 0-1- .5H8.5a1 1 0 0 0-1 .5L6 7"/><path d="M7 7h10v11a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2V7Z"/></svg>`,
            'Shot': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 7h-2L15 2H9L7 7H5"/><path d="M7 7v11a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V7"/></svg>`,
            'Star': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2Z"/></svg>`,
            'Trash': `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`,
            'Cocktail': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 17.5 22 10l-1.5-1.5L8 15l-1.5 1.5L2 22l5.5-1.5Z"/><path d="m16 8 4 4"/><path d="m2 22 5.5-1.5"/></svg>`
        };
        
        const COCKTAIL_PRESETS = {
            'Mojito': { totalVol: 25, spiritAbv: 40, spiritPercent: 20 }, 'Gin Tonic': { totalVol: 20, spiritAbv: 40, spiritPercent: 25 },
            'Spritz': { totalVol: 18, spiritAbv: 11, spiritPercent: 50 }, 'Margarita': { totalVol: 12, spiritAbv: 40, spiritPercent: 42 },
            'Cosmo': { totalVol: 12, spiritAbv: 40, spiritPercent: 42 }, 'M. Mule': { totalVol: 20, spiritAbv: 40, spiritPercent: 25 },
            'Pina Colada': { totalVol: 22, spiritAbv: 40, spiritPercent: 23 }, 'Sex on Beach': { totalVol: 20, spiritAbv: 40, spiritPercent: 20 },
        };

        // --- DOM Elements ---
        const setupScreen = document.getElementById('setup-screen'), mainScreen = document.getElementById('main-screen'), addDrinkModal = document.getElementById('add-drink-modal'),
              setupForm = document.getElementById('setup-form'), addDrinkBtn = document.getElementById('add-drink-btn'), cancelBtn = document.getElementById('cancel-drink-btn'),
              addDrinkForm = document.getElementById('add-drink-form'), presetBtns = document.querySelectorAll('.preset-btn'), favBtn = document.getElementById('fav-drink-preset-btn'),
              resetBtn = document.getElementById('reset-btn'), historyDiv = document.getElementById('drinks-history'), sisterDrinkBtn = document.getElementById('sister-drink-btn'),
              userNameInput = document.getElementById('user-name'), drinkNameInput = document.getElementById('drink-name'), sessionTimeDisplay = document.getElementById('session-time'),
              editDrinkBtn = document.getElementById('edit-drink-btn'), addWaterBtn = document.getElementById('add-water-btn'),
              editingDrinkIdInput = document.getElementById('editing-drink-id'), modalTitle = document.getElementById('modal-title'), saveDrinkBtn = document.getElementById('save-drink-btn'),
              mixedSection = document.getElementById('mixed-drink-section'), isMixedCheck = document.getElementById('is-mixed-drink'),
              mixedFields = document.getElementById('mixed-drink-fields'), simpleFields = document.getElementById('simple-drink-fields'),
              cocktailPresetsContainer = document.getElementById('cocktail-presets-container'), cocktailPresetsGrid = document.getElementById('cocktail-presets-grid');
        
        // --- State & Constants ---
        let userProfile = {}, drinks = [], sessionStartTime = null, bacUpdateInterval = null, timerUpdateAnimation = null, currentDrinkType = 'Bi√®re', bacChart = null, selectedDrinkId = null;
        const ALCOHOL_DENSITY = 0.789, MALE_CONSTANT = 0.68, FEMALE_CONSTANT = 0.55, ELIMINATION_RATE_PER_HOUR = 0.15, JUIMOR_SCALE_MAX_BAC = 2.0;
        const VOLUME_STEPS = [3, 4, 12.5, 25, 33, 50, 75, 100, 150, 200];
        const GAUGE_COLORS = { blue: { hex: '#60a5fa', text: 'text-blue-400' }, green: { hex: '#4ade80', text: 'text-green-400' }, orange: { hex: '#f59e0b', text: 'text-amber-500' }, red: { hex: '#f87171', text: 'text-red-400' } };

        // --- VALIDATION ---
        userNameInput.addEventListener('input', () => { userNameInput.value = userNameInput.value.replace(/[^\p{L} ]/gu, ''); });
        drinkNameInput.addEventListener('input', () => { drinkNameInput.value = drinkNameInput.value.replace(/[^\p{L} ]/gu, ''); });
        
        // --- STORAGE ---
        function saveState() { localStorage.setItem('juimorState', JSON.stringify({ userProfile, drinks, sessionStartTime: sessionStartTime ? sessionStartTime.toISOString() : null })); }
        function loadState() {
            const savedState = localStorage.getItem('juimorState');
            if (savedState) {
                const s = JSON.parse(savedState);
                userProfile = s.userProfile; drinks = s.drinks.map(d => ({ ...d, time: new Date(d.time) }));
                sessionStartTime = s.sessionStartTime ? new Date(s.sessionStartTime) : null;
                return true;
            } return false;
        }
        function clearState() { localStorage.removeItem('juimorState'); location.reload(); }

        // --- INITIALIZATION ---
        function initializeApp() {
            createSteppers(document.body); populatePresetButtons(); populateCocktailPresets();
            if (loadState() && userProfile.name) startSession();
            else setupScreen.style.display = 'flex';
        }
        function createSteppers(container) {
            container.querySelectorAll('.number-stepper').forEach(el => {
                const value = parseFloat(el.dataset.value);
                el.innerHTML = `<button type="button" class="stepper-btn bg-gray-700/70 rounded-l-lg px-3 py-3 text-lg font-bold">-</button><span class="flex-grow text-center text-lg font-semibold bg-gray-900/50 py-3">${value}<span class="text-sm text-gray-400 ml-1">${el.dataset.unit}</span></span><button type="button" class="stepper-btn bg-gray-700/70 rounded-r-lg px-3 py-3 text-lg font-bold">+</button>`;
                el.classList.add('flex', 'items-center', 'justify-between', 'w-full', 'border-2', 'border-gray-600', 'rounded-lg');
            });
        }
        function populatePresetButtons() { presetBtns.forEach(btn => { if (btn.dataset.type) btn.innerHTML = `${ICONS[btn.dataset.type]}<span class="mt-1 font-bold text-xs">${btn.dataset.name}</span>`; }); }
        function populateCocktailPresets() {
            cocktailPresetsGrid.innerHTML = Object.keys(COCKTAIL_PRESETS).map(name => 
                `<button type="button" class="cocktail-preset-btn text-xs font-semibold bg-gray-700/80 p-2 rounded-lg" data-name="${name}">${name}</button>`
            ).join('');
        }

        // --- Event Listeners ---
        document.getElementById('target-level').addEventListener('input', (e) => { document.getElementById('target-level-display').textContent = e.target.value; });
        resetBtn.addEventListener('click', clearState); setupForm.addEventListener('submit', handleSetup); addDrinkBtn.addEventListener('click', openModalForNewDrink);
        cancelBtn.addEventListener('click', closeModal); addDrinkForm.addEventListener('submit', handleSaveDrink); presetBtns.forEach(btn => btn.addEventListener('click', handlePresetClick));
        historyDiv.addEventListener('click', handleHistoryClick); document.body.addEventListener('click', handleStepperClick); sisterDrinkBtn.addEventListener('click', handleSisterDrink);
        editDrinkBtn.addEventListener('click', () => { if (selectedDrinkId) openModalForEdit(selectedDrinkId); }); addWaterBtn.addEventListener('click', handleAddWater);
        isMixedCheck.addEventListener('change', (e) => { mixedFields.classList.toggle('hidden', !e.target.checked); simpleFields.classList.toggle('hidden', e.target.checked); });
        cocktailPresetsGrid.addEventListener('click', handleCocktailPresetClick);

        // --- Handlers ---
        function handleSetup(e) {
            e.preventDefault();
            const favAbvStepper = setupForm.querySelector('[data-unit="¬∞"]'); const favVolStepper = setupForm.querySelector('[data-unit="cl"]'); const favType = document.getElementById('fav-drink-type').value;
            userProfile = {
                name: userNameInput.value, weight: parseFloat(document.getElementById('user-weight').value), gender: document.getElementById('user-gender').value,
                targetLevel: parseInt(document.getElementById('target-level').value), favDrink: { type: favType, name: favType, abv: parseFloat(favAbvStepper.dataset.value), vol: parseFloat(favVolStepper.dataset.value) }
            };
            sessionStartTime = new Date(); drinks = []; saveState(); startSession();
        }
        function handleSaveDrink(e) {
            e.preventDefault();
            let alcoholGrams, abv, vol; const drinkNameVal = drinkNameInput.value; const id = editingDrinkIdInput.value;
            if (isMixedCheck.checked) {
                const [totalVol, spiritAbv, spiritPercent] = Array.from(mixedFields.querySelectorAll('.number-stepper')).map(s => parseFloat(s.dataset.value));
                if ([totalVol, spiritAbv, spiritPercent].some(isNaN)) return;
                const spiritVolumeCL = totalVol * (spiritPercent / 100); alcoholGrams = (spiritVolumeCL * 10) * (spiritAbv / 100) * ALCOHOL_DENSITY;
                abv = ((spiritVolumeCL * spiritAbv) / totalVol).toFixed(1); vol = totalVol;
            } else {
                abv = parseFloat(document.getElementById('drink-abv-stepper').dataset.value); vol = parseFloat(document.getElementById('drink-vol-stepper').dataset.value);
                if (isNaN(abv) || isNaN(vol)) return;
                alcoholGrams = (vol * 10) * (abv / 100) * ALCOHOL_DENSITY;
            }
            const drinkTime = id ? drinks.find(d => d.id == id).time : new Date(); const drinkData = { name: drinkNameVal, grams: alcoholGrams, type: currentDrinkType, abv, vol };
            if (id) {
                const index = drinks.findIndex(d => d.id == id);
                if (index !== -1) drinks[index] = { ...drinks[index], ...drinkData };
            } else { drinks.push({ ...drinkData, id: Date.now(), time: drinkTime }); }
            saveState(); updateFullUI(); closeModal();
        }
        function handlePresetClick(e) {
            const btn = e.currentTarget; resetMixedDrinkFields(); cocktailPresetsContainer.classList.add('hidden');
            const type = btn.dataset.type; currentDrinkType = type;
            if (type === 'Cocktail') { cocktailPresetsContainer.classList.remove('hidden'); drinkNameInput.value = ''; return; }
            if (btn.id === 'fav-drink-preset-btn') {
                const fav = userProfile.favDrink; currentDrinkType = fav.type; drinkNameInput.value = fav.name;
                updateStepper('drink-abv-stepper', fav.abv); updateStepper('drink-vol-stepper', fav.vol);
            } else {
                drinkNameInput.value = btn.dataset.name;
                updateStepper('drink-abv-stepper', btn.dataset.abv); updateStepper('drink-vol-stepper', btn.dataset.vol);
            }
            mixedSection.classList.toggle('hidden', type !== 'Spiritueux');
        }
        function handleCocktailPresetClick(e) {
            const btn = e.target.closest('.cocktail-preset-btn'); if (!btn) return;
            const name = btn.dataset.name; const preset = COCKTAIL_PRESETS[name]; if (!preset) return;
            drinkNameInput.value = name; currentDrinkType = 'Cocktail'; isMixedCheck.checked = true;
            mixedFields.classList.remove('hidden'); simpleFields.classList.add('hidden'); mixedSection.classList.remove('hidden');
            const [totalVolStepper, spiritAbvStepper, spiritPercentStepper] = mixedFields.querySelectorAll('.number-stepper');
            updateStepper(totalVolStepper, preset.totalVol); updateStepper(spiritAbvStepper, preset.spiritAbv); updateStepper(spiritPercentStepper, preset.spiritPercent);
        }
        function handleHistoryClick(e) {
            const item = e.target.closest('.history-item'); if (!item) return; const id = parseInt(item.dataset.id);
            if (item.dataset.type === 'Eau') { if (e.target.closest('.delete-drink-btn')) { drinks = drinks.filter(d => d.id !== id); saveState(); updateFullUI(); } return; }
            if (e.target.closest('.delete-drink-btn')) {
                drinks = drinks.filter(d => d.id !== id); if (selectedDrinkId === id) selectedDrinkId = null;
            } else { selectedDrinkId = (selectedDrinkId === id) ? null : id; }
            saveState(); updateFullUI();
        }
        function handleAddWater() { drinks.push({ name: "Verre d'eau", type: "Eau", time: new Date(), id: Date.now() }); saveState(); updateFullUI(); }
        function handleSisterDrink() {
            if (!selectedDrinkId) return;
            const originalDrink = drinks.find(d => d.id === selectedDrinkId);
            if (originalDrink) { drinks.push({ ...originalDrink, time: new Date(), id: Date.now() }); selectedDrinkId = null; saveState(); updateFullUI(); }
        }
        function handleStepperClick(e) {
            const btn = e.target.closest('.stepper-btn'); if (!btn) return; const stepper = btn.parentElement; let value = parseFloat(stepper.dataset.value);
            if (stepper.dataset.unit === 'cl') {
                let currentIndex = VOLUME_STEPS.indexOf(value);
                if (currentIndex === -1) { if (btn.textContent === '+') { currentIndex = VOLUME_STEPS.findIndex(step => step >= value); if (currentIndex === -1) currentIndex = VOLUME_STEPS.length - 1; } else { const reversedIndex = [...VOLUME_STEPS].reverse().findIndex(step => step <= value); if (reversedIndex === -1) currentIndex = 0; else currentIndex = VOLUME_STEPS.length - 1 - reversedIndex; } }
                if (btn.textContent === '+') { currentIndex = Math.min(VOLUME_STEPS.length - 1, currentIndex + 1); } else { currentIndex = Math.max(0, currentIndex - 1); }
                value = VOLUME_STEPS[currentIndex];
            } else {
                const step = parseFloat(stepper.dataset.step || 1); const min = parseFloat(stepper.dataset.min); const max = parseFloat(stepper.dataset.max);
                value += (btn.textContent === '+') ? step : -step;
                if (!isNaN(min)) value = Math.max(min, value); if (!isNaN(max)) value = Math.min(max, value);
            }
            updateStepper(stepper, value);
        }
        function updateStepper(stepperOrId, value) {
            const stepper = (typeof stepperOrId === 'string') ? document.getElementById(stepperOrId) : stepperOrId; if (!stepper) return;
            const cleanValue = parseFloat(parseFloat(value).toFixed(2)); stepper.dataset.value = cleanValue; stepper.querySelector('span').firstChild.textContent = cleanValue;
        }
        function openModalForNewDrink() {
            modalTitle.textContent = "Nouvelle Conso"; saveDrinkBtn.textContent = "Ajouter"; editingDrinkIdInput.value = '';
            addDrinkForm.reset(); resetMixedDrinkFields(); cocktailPresetsContainer.classList.add('hidden'); addDrinkModal.classList.remove('hidden');
        }
        function openModalForEdit(drinkId) {
            const drink = drinks.find(d => d.id === drinkId); if (!drink) return;
            modalTitle.textContent = "Modifier la conso"; saveDrinkBtn.textContent = "Modifier"; editingDrinkIdInput.value = drink.id;
            addDrinkForm.reset(); resetMixedDrinkFields(); cocktailPresetsContainer.classList.add('hidden'); drinkNameInput.value = drink.name;
            updateStepper('drink-abv-stepper', drink.abv); updateStepper('drink-vol-stepper', drink.vol); addDrinkModal.classList.remove('hidden');
        }
        function closeModal() {
            addDrinkForm.reset(); resetMixedDrinkFields(); editingDrinkIdInput.value = ''; cocktailPresetsContainer.classList.add('hidden');
            addDrinkModal.classList.add('hidden');
        }
        function resetMixedDrinkFields() { mixedSection.classList.add('hidden'); mixedFields.classList.add('hidden'); isMixedCheck.checked = false; simpleFields.classList.remove('hidden'); }
        
        // --- Core Functions ---
        function startSession() {
            setupScreen.style.display = 'none'; mainScreen.style.display = 'flex';
            document.getElementById('display-name').textContent = userProfile.name; document.getElementById('display-target').textContent = userProfile.targetLevel;
            const fav = userProfile.favDrink; favBtn.innerHTML = `${ICONS.Star}<span class="ml-3 font-bold">Pr√©f√©r√©e</span>`;
            favBtn.dataset.type = fav.type; favBtn.dataset.name = fav.name; favBtn.dataset.abv = fav.abv; favBtn.dataset.vol = fav.vol;
            initializeChart();
            if (bacUpdateInterval) clearInterval(bacUpdateInterval); if (timerUpdateAnimation) cancelAnimationFrame(timerUpdateAnimation);
            bacUpdateInterval = setInterval(updateBacData, 5000);
            timerUpdateAnimation = requestAnimationFrame(updateTimer);
            updateFullUI();
        }

        // AM√âLIORATION PERFORMANCE : Le timer tourne dans sa propre boucle ultra-l√©g√®re
        function updateTimer() {
            if (!sessionStartTime) return;
            const elapsed = new Date(Date.now() - sessionStartTime);
            const [h, m, s] = [elapsed.getUTCHours(), elapsed.getUTCMinutes(), elapsed.getUTCSeconds()].map(t => String(t).padStart(2, '0'));
            sessionTimeDisplay.textContent = `Session: ${h}:${m}:${s}`;
            timerUpdateAnimation = requestAnimationFrame(updateTimer);
        }

        function calculateBAC(atTime) {
            if (!userProfile.weight) return 0;
            const genderConstant = userProfile.gender === 'male' ? MALE_CONSTANT : FEMALE_CONSTANT; const bodyWater = userProfile.weight * genderConstant;
            const totalGramsIngested = drinks.filter(drink => drink.grams && drink.time <= atTime).reduce((sum, drink) => sum + drink.grams, 0);
            if (totalGramsIngested === 0) return 0; const peakBAC = totalGramsIngested / bodyWater;
            const hoursSinceStart = (atTime - sessionStartTime) / (3600 * 1000); const alcoholEliminated = ELIMINATION_RATE_PER_HOUR * hoursSinceStart;
            return Math.max(0, peakBAC - alcoholEliminated);
        }
        
        // AM√âLIORATION PERFORMANCE : Cette fonction fait les calculs lourds toutes les 5s
        function updateBacData() {
            if (!sessionStartTime) return;
            const now = new Date();
            const currentBAC_gL = calculateBAC(now); const juimorLevel = Math.min(10, (currentBAC_gL / JUIMOR_SCALE_MAX_BAC) * 10);
            document.getElementById('current-level').textContent = juimorLevel.toFixed(1);
            const gauge = document.getElementById('juimor-gauge'); const levelText = document.getElementById('current-level');
            const legalLimitJuimor = (0.5 / JUIMOR_SCALE_MAX_BAC) * 10; let color;
            if (juimorLevel > 7.5) color = GAUGE_COLORS.red; else if (juimorLevel > 5) color = GAUGE_COLORS.orange; else if (juimorLevel > legalLimitJuimor) color = GAUGE_COLORS.green; else color = GAUGE_COLORS.blue;
            gauge.style.stroke = color.hex; levelText.className = `text-7xl md:text-8xl font-black transition-colors duration-500 ${color.text}`;
            gauge.style.strokeDashoffset = (2 * Math.PI * 45) * (1 - (juimorLevel / 10));
            document.getElementById('bac-legal-info').textContent = currentBAC_gL > 0 ? `Taux estim√©: ${currentBAC_gL.toFixed(2)} g/L` : '';
            const timeToZeroHours = currentBAC_gL / ELIMINATION_RATE_PER_HOUR; const timeToZeroEl = document.getElementById('time-to-zero');
            if (timeToZeroHours > 0) { const zeroTime = new Date(now.getTime() + timeToZeroHours * 3600000); timeToZeroEl.textContent = `Retour √† 0 estim√© √† ${zeroTime.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}`; } 
            else { timeToZeroEl.textContent = ''; }
            updateChart(color.hex);
        }
        
        // AM√âLIORATION PERFORMANCE : Cette fonction met √† jour l'historique et les boutons (uniquement quand c'est n√©cessaire)
        function updateFullUI() {
            updateBacData(); // Lance un calcul imm√©diat
            const isDrinkSelected = selectedDrinkId !== null;
            addDrinkBtn.classList.toggle('hidden', isDrinkSelected); addDrinkBtn.classList.toggle('col-span-2', !isDrinkSelected);
            editDrinkBtn.classList.toggle('hidden', !isDrinkSelected); sisterDrinkBtn.classList.toggle('hidden', !isDrinkSelected);
            addWaterBtn.classList.toggle('col-span-2', !isDrinkSelected); addWaterBtn.classList.toggle('col-span-full', isDrinkSelected);
            updateHistory();
        }

        function updateHistory() {
            historyDiv.innerHTML = (drinks.length > 0) ? drinks.slice().reverse().map(drink => {
                const icon = ICONS[drink.type] || ICONS['Cocktail'];
                if (drink.type === 'Eau') {
                    return `<div class="history-item bg-gray-700/50 p-2 rounded-md flex justify-between items-center border-2 border-transparent" data-id="${drink.id}" data-type="Eau"><div class="flex items-center space-x-3"><span class="text-blue-400">üíß</span><p class="font-medium">${drink.name}</p></div><div class="flex items-center space-x-3"><p class="text-sm text-gray-400">${new Date(drink.time).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}</p><button class="delete-drink-btn text-gray-500 hover:text-red-400 p-1">${ICONS.Trash}</button></div></div>`;
                }
                return `<div class="history-item bg-gray-700/50 p-2 rounded-md flex justify-between items-center border-2 border-transparent cursor-pointer ${drink.id === selectedDrinkId ? 'selected' : ''}" data-id="${drink.id}"><div class="flex items-center space-x-3 pointer-events-none"><span class="text-amber-400">${icon}</span><div><p class="font-medium">${drink.name}</p><p class="text-xs text-gray-400">${drink.vol}cl √† ${drink.abv}¬∞</p></div></div><div class="flex items-center space-x-3"><p class="text-sm text-gray-400 pointer-events-none">${new Date(drink.time).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}</p><button class="delete-drink-btn text-gray-500 hover:text-red-400 p-1">${ICONS.Trash}</button></div></div>`;
            }).join('') : '<p class="text-gray-500 text-center">Aucune boisson pour le moment.</p>';
        }
        
        // --- CHART FUNCTIONS ---
        let chartInitialized = false;
        function initializeChart() {
            const ctx = document.getElementById('bac-chart').getContext('2d'); if (bacChart) bacChart.destroy();
            bacChart = new Chart(ctx, {
                type: 'line', data: { labels: [], datasets: [{ data: [], borderWidth: 2, tension: 0.4, fill: true }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: '#9ca3af' }, grid: { color: '#4b5563' } }, x: { ticks: { color: '#9ca3af' }, grid: { color: '#4b5563' } } }, plugins: { legend: { display: false } } }
            });
            chartInitialized = true;
        }
        function updateChart(color) {
            if (!chartInitialized || !sessionStartTime) return;
            const now = new Date(), labels = [], data = []; const sessionDurationMinutes = (now - sessionStartTime) / 60000;
            const step = Math.max(5, Math.floor(sessionDurationMinutes / 20));
            for (let i = 0; i <= sessionDurationMinutes; i += step) {
                const timePoint = new Date(sessionStartTime.getTime() + i * 60000);
                labels.push(timePoint.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })); data.push(calculateBAC(timePoint).toFixed(3));
            }
            if (!labels.includes(now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }))) {
                 labels.push(now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })); data.push(calculateBAC(now).toFixed(3));
            }
            bacChart.data.labels = labels; bacChart.data.datasets[0].data = data;
            bacChart.data.datasets[0].borderColor = color; bacChart.data.datasets[0].backgroundColor = color + '33';
            bacChart.update('none');
        }
        
        initializeApp();
    });
    </script>
</body>
</html>